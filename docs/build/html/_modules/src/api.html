

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.api &mdash; DeepRetro 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DeepRetro
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">Models Used in DeepRetro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference_landing.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to DeepRetro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DeepRetro</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Flask API for the DeepRetro Retrosynthesis Application.</span>

<span class="sd">This module sets up and runs a Flask web server to provide an HTTP API for</span>
<span class="sd">the core retrosynthesis functionalities of the DeepRetro project.</span>

<span class="sd">Key Features:</span>

<span class="sd">-   **Authentication:** Endpoints are protected by an API key mechanism.</span>
<span class="sd">    The API key must be provided in the `X-API-KEY` header and is configured</span>
<span class="sd">    via the `API_KEY` environment variable.</span>
<span class="sd">-   **CORS Enabled:** Cross-Origin Resource Sharing is enabled for all routes.</span>
<span class="sd">-   **Retrosynthesis Endpoint (`/api/retrosynthesis`):**</span>
<span class="sd">    The primary endpoint for submitting a molecule (SMILES string) and receiving</span>
<span class="sd">    retrosynthesis predictions. Supports various LLM and AiZynthFinder model</span>
<span class="sd">    configurations and optional processing flags.</span>
<span class="sd">-   **Cache Management (`/api/clear_molecule_cache`):**</span>
<span class="sd">    Allows clearing cached results for specific molecules.</span>
<span class="sd">-   **Rerun Capabilities (`/api/rerun_retrosynthesis`, `/api/partial_rerun`):**</span>
<span class="sd">    Endpoints to re-trigger retrosynthesis, potentially with cache clearing.</span>
<span class="sd">-   **Health Check (`/api/health`):**</span>
<span class="sd">    A simple endpoint to verify if the API is operational.</span>
<span class="sd">-   **Result Persistence (`partial.json`):**</span>
<span class="sd">    Helper functions (`save_result`, `load_result`) are provided to save the</span>
<span class="sd">    latest retrosynthesis output to a local JSON file, possibly for debugging</span>
<span class="sd">    or stateful interactions, though this is a simple file-based approach.</span>

<span class="sd">Environment Variables:</span>

<span class="sd">-   `API_KEY`: The secret key required for API authentication.</span>

<span class="sd">The API leverages the `src.main.main()` function for the core retrosynthesis</span>
<span class="sd">logic and `src.cache` for managing cached data.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">rootutils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

<span class="n">root_dir</span> <span class="o">=</span> <span class="n">rootutils</span><span class="o">.</span><span class="n">setup_root</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span>
                                <span class="n">indicator</span><span class="o">=</span><span class="s2">&quot;.project-root&quot;</span><span class="p">,</span>
                                <span class="n">pythonpath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">load_dotenv</span><span class="p">()</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">main</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_cache_for_molecule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.variables</span><span class="w"> </span><span class="kn">import</span> <span class="n">AZ_MODEL_LIST</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># API key loaded from environment variable</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;API_KEY&#39;</span><span class="p">)</span>

<span class="c1"># For testing: Uncomment the line below to see the loaded API_KEY</span>
<span class="c1"># print(f&quot;DEBUG: API_KEY loaded from environment: {API_KEY}&quot;)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">API_KEY</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CRITICAL ERROR: The &#39;API_KEY&#39; environment variable is not set.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please set this variable in your .env file or your system environment.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: API_KEY=&#39;your-chosen-secret-key&#39;&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Exit if the API key is not configured</span>

<span class="c1"># File path for storing results</span>
<span class="n">PARTIAL_JSON_PATH</span> <span class="o">=</span> <span class="s2">&quot;partial.json&quot;</span>


<span class="c1"># Functions for JSON file storage</span>
<div class="viewcode-block" id="save_result">
<a class="viewcode-back" href="../../api_module.html#src.api.save_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_result</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a retrosynthesis result to the `partial.json` file.</span>

<span class="sd">    This function stores the provided SMILES string and its corresponding</span>
<span class="sd">    retrosynthesis result in a JSON file named `partial.json`. Any existing</span>
<span class="sd">    content in this file will be overwritten.</span>

<span class="sd">    The saved data structure is a JSON object:</span>
<span class="sd">    `{&quot;smiles&quot;: &quot;&lt;input_smiles&gt;&quot;, &quot;result&quot;: &lt;retrosynthesis_output&gt;}`</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles (str): The SMILES string of the molecule for which the result is saved.</span>
<span class="sd">        result (dict): The retrosynthesis result data (typically a dictionary).</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The path to the saved file (`PARTIAL_JSON_PATH`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a data structure with the SMILES and result</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>

    <span class="c1"># Save the result to the file (overwriting any existing data)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PARTIAL_JSON_PATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result for </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">PARTIAL_JSON_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PARTIAL_JSON_PATH</span></div>



<div class="viewcode-block" id="load_result">
<a class="viewcode-back" href="../../api_module.html#src.api.load_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_result</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the most recent retrosynthesis result from `partial.json`.</span>

<span class="sd">    Attempts to read and parse the JSON data stored in `PARTIAL_JSON_PATH`.</span>
<span class="sd">    This file is expected to contain a SMILES string and its associated</span>
<span class="sd">    retrosynthesis result, as saved by `save_result()`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[str | None, dict | None]:</span>
<span class="sd">            A tuple containing the SMILES string and the result dictionary.</span>
<span class="sd">            Returns `(None, None)` if the file does not exist, cannot be read,</span>
<span class="sd">            or if a parsing error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PARTIAL_JSON_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No result file found at </span><span class="si">{</span><span class="n">PARTIAL_JSON_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Load the result from the file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PARTIAL_JSON_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">smiles</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result for </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2"> loaded from </span><span class="si">{</span><span class="n">PARTIAL_JSON_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading result file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<span class="c1"># Authentication decorator</span>
<div class="viewcode-block" id="require_api_key">
<a class="viewcode-back" href="../../api_module.html#src.api.require_api_key">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">require_api_key</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to enforce API key authentication for Flask routes.</span>

<span class="sd">    This decorator checks for the presence and validity of an API key sent</span>
<span class="sd">    in the `X-API-KEY` request header. The required API key is loaded from</span>
<span class="sd">    the `API_KEY` environment variable.</span>

<span class="sd">    If the `X-API-KEY` header is missing or contains an incorrect key, the</span>
<span class="sd">    decorated endpoint will return a 401 Unauthorized error with a JSON body:</span>
<span class="sd">    `{&quot;error&quot;: &quot;Unauthorized&quot;}`.</span>

<span class="sd">    `OPTIONS` requests are allowed to pass through without an API key check</span>
<span class="sd">    to support CORS preflight requests.</span>

<span class="sd">    Args:</span>
<span class="sd">        f (Callable): The Flask view function to decorate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: The decorated view function with API key checking.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow OPTIONS requests to bypass API key check</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_key</span> <span class="o">==</span> <span class="n">API_KEY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="k">return</span> <span class="n">decorated_function</span></div>



<div class="viewcode-block" id="retrosynthesis_api">
<a class="viewcode-back" href="../../api_module.html#src.api.retrosynthesis_api">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/retrosynthesis&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">retrosynthesis_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint to perform retrosynthesis on a target SMILES string.</span>

<span class="sd">    This is the primary endpoint for initiating a retrosynthesis task.</span>
<span class="sd">    It accepts a JSON payload containing the target molecule&#39;s SMILES string</span>
<span class="sd">    and optional parameters to control the LLM, AiZynthFinder model,</span>
<span class="sd">    and other processing flags.</span>

<span class="sd">    **Request JSON Body:**</span>

<span class="sd">    -   `smiles` (str, required): The SMILES string of the target molecule.</span>
<span class="sd">    -   `model_type` (str, optional): Specifies the LLM to use.</span>
<span class="sd">        Valid values: &quot;claude3&quot; (default), &quot;claude37&quot;, &quot;deepseek&quot;.</span>
<span class="sd">    -   `advanced_prompt` (str or bool, optional): If &quot;true&quot; or `True`, appends</span>
<span class="sd">        &quot;:adv&quot; to the LLM identifier, potentially selecting a different</span>
<span class="sd">        prompt version. Defaults to `False`.</span>
<span class="sd">    -   `model_version` (str, optional): Specifies the AiZynthFinder model.</span>
<span class="sd">        Defaults to &quot;USPTO&quot;. Must be a value from `src.variables.AZ_MODEL_LIST`.</span>
<span class="sd">    -   `stability_flag` (str, optional): &quot;True&quot; or &quot;False&quot; to enable/disable</span>
<span class="sd">        stability checks. Defaults to &quot;False&quot;.</span>
<span class="sd">    -   `hallucination_check` (str, optional): &quot;True&quot; or &quot;False&quot; to enable/disable</span>
<span class="sd">        hallucination checks. Defaults to &quot;False&quot;.</span>

<span class="sd">    **Responses:**</span>

<span class="sd">    -   **200 OK:** Success. The body contains the JSON result from the</span>
<span class="sd">        retrosynthesis process (output of `src.main.main()`). The result is also</span>
<span class="sd">        saved to `partial.json`.</span>
<span class="sd">    -   **400 Bad Request:** Invalid input (e.g., missing `smiles`, invalid SMILES</span>
<span class="sd">        string, invalid parameter values).</span>
<span class="sd">        JSON body: `{&quot;error&quot;: &quot;&lt;error message&gt;&quot;}`.</span>
<span class="sd">    -   **401 Unauthorized:** Missing or invalid API key.</span>
<span class="sd">        JSON body: `{&quot;error&quot;: &quot;Unauthorized&quot;}`.</span>
<span class="sd">    -   **500 Internal Server Error:** An unexpected error occurred during</span>
<span class="sd">        retrosynthesis processing.</span>
<span class="sd">        JSON body: `{&quot;error&quot;: &quot;Error in retrosynthesis: &lt;exception message&gt;. Please rerun.&quot;}`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;smiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="s2">&quot;SMILES string is required. Please include a &#39;smiles&#39; field&quot;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="n">smiles</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span>

    <span class="c1"># Check if the SMILES string is valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid SMILES string&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Advanced model - DeepSeek-R1</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>  <span class="c1"># Default is Claude 3 Opus</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;model_type&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;claude3&quot;</span><span class="p">,</span> <span class="s2">&quot;claude37&quot;</span><span class="p">,</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model type: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Select the appropriate LLM based on model_type</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;fireworks_ai/accounts/fireworks/models/deepseek-r1&quot;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;claude37&quot;</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;anthropic/claude-3-7-sonnet-20250219&quot;</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default to Claude 3 Opus</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;claude-3-opus-20240229&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Advanced Prompt - To use the more guardrails prompt</span>
    <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;advanced_prompt&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;advanced_prompt&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">advanced_prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing advanced prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">advanced_prompt</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="o">+</span> <span class="s2">&quot;:adv&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Choose AiZynthFinder model</span>
    <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;model_version&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">az_model</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_version&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">az_model</span> <span class="ow">in</span> <span class="n">AZ_MODEL_LIST</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Stability check flag</span>
    <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;stability_flag&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stability_flag</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stability_flag&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">stability_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing stability flag: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Hallucination check flag</span>
    <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;hallucination_check&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">hallucination_check</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hallucination_check&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">hallucination_check</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing hallucination check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Run retrosynthesis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run retrosynthesis</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
                      <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                      <span class="n">az_model</span><span class="o">=</span><span class="n">az_model</span><span class="p">,</span>
                      <span class="n">stability_flag</span><span class="o">=</span><span class="n">stability_flag</span><span class="p">,</span>
                      <span class="n">hallucination_check</span><span class="o">=</span><span class="n">hallucination_check</span><span class="p">)</span>

        <span class="c1"># Store the result in partial.json</span>
        <span class="n">save_result</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
             <span class="sa">f</span><span class="s2">&quot;Error in retrosynthesis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please rerun.&quot;</span><span class="p">}),</span> <span class="mi">500</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span></div>



<div class="viewcode-block" id="health">
<a class="viewcode-back" href="../../api_module.html#src.api.health">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/health&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint for the API.</span>

<span class="sd">    Responds with a simple status message if the API is running and accessible.</span>
<span class="sd">    Requires API key authentication.</span>

<span class="sd">    **Responses:**</span>

<span class="sd">    -   **200 OK:** API is healthy.</span>
<span class="sd">        JSON body: `{&quot;status&quot;: &quot;healthy&quot;}`.</span>
<span class="sd">    -   **401 Unauthorized:** Missing or invalid API key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">}),</span> <span class="mi">200</span></div>



<div class="viewcode-block" id="clear_molecule_cache">
<a class="viewcode-back" href="../../api_module.html#src.api.clear_molecule_cache">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/clear_molecule_cache&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_molecule_cache</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint to clear the cache for a specific molecule.</span>

<span class="sd">    Removes any cached retrosynthesis results for the given molecule string.</span>
<span class="sd">    This is useful if you want to ensure a fresh computation for a molecule.</span>

<span class="sd">    **Request JSON Body:**</span>

<span class="sd">    -   `molecule` (str, required): The SMILES string or identifier of the molecule</span>
<span class="sd">        whose cache should be cleared.</span>

<span class="sd">    **Responses:**</span>

<span class="sd">    -   **200 OK:** Cache cleared successfully.</span>
<span class="sd">        JSON body: `{&quot;status&quot;: &quot;success&quot;}`.</span>
<span class="sd">    -   **400 Bad Request:** `molecule` field is missing in the request.</span>
<span class="sd">        JSON body: `{&quot;error&quot;: &quot;Molecule string is required&quot;}`.</span>
<span class="sd">    -   **401 Unauthorized:** Missing or invalid API key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;molecule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Molecule string is required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">molecule</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">clear_cache_for_molecule</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}),</span> <span class="mi">200</span></div>



<div class="viewcode-block" id="rerun_retrosynthesis">
<a class="viewcode-back" href="../../api_module.html#src.api.rerun_retrosynthesis">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/rerun_retrosynthesis&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rerun_retrosynthesis</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint to rerun retrosynthesis for a specific molecule, clearing its cache first.</span>

<span class="sd">    This endpoint first clears any existing cache for the target molecule and</span>
<span class="sd">    then performs a fresh retrosynthesis run. It accepts the same parameters</span>
<span class="sd">    as the `/api/retrosynthesis` endpoint to control the models and flags.</span>

<span class="sd">    **Request JSON Body:**</span>

<span class="sd">    -   `smiles` (str, required): The SMILES string of the target molecule.</span>
<span class="sd">    -   `model_type` (str, optional): Specifies the LLM. See `/api/retrosynthesis`.</span>
<span class="sd">    -   `advanced_prompt` (str or bool, optional): See `/api/retrosynthesis`.</span>
<span class="sd">    -   `model_version` (str, optional): Specifies AiZynthFinder model. See `/api/retrosynthesis`.</span>
<span class="sd">    -   `stability_flag` (str, optional): See `/api/retrosynthesis`.</span>
<span class="sd">    -   `hallucination_check` (str, optional): See `/api/retrosynthesis`.</span>

<span class="sd">    **Responses:**</span>

<span class="sd">    -   **200 OK:** Success. See `/api/retrosynthesis`.</span>
<span class="sd">    -   **400 Bad Request:** Invalid input. See `/api/retrosynthesis`.</span>
<span class="sd">    -   **401 Unauthorized:** Missing or invalid API key.</span>
<span class="sd">    -   **500 Internal Server Error:** See `/api/retrosynthesis`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;smiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="s2">&quot;Molecule string is required, Please include a &#39;smiles&#39; field&quot;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="n">molecule</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span>

    <span class="c1"># Clear the cache for the molecule</span>
    <span class="n">clear_cache_for_molecule</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>

    <span class="c1"># Check if the SMILES string is valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">molecule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid SMILES string&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Advanced model - DeepSeek-R1</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>  <span class="c1"># Default is Claude 3 Opus</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;model_type&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;claude3&quot;</span><span class="p">,</span> <span class="s2">&quot;claude37&quot;</span><span class="p">,</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model type: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Select the appropriate LLM based on model_type</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;fireworks_ai/accounts/fireworks/models/deepseek-r1&quot;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;claude37&quot;</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;anthropic/claude-3-7-sonnet-20250219&quot;</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default to Claude 3 Opus</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;claude-3-opus-20240229&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Advanced prompt handling</span>
    <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;advanced_prompt&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;advanced_prompt&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">advanced_prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing advanced prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">advanced_prompt</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="o">+</span> <span class="s2">&quot;:adv&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Choose AiZynthFinder model</span>
    <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;model_version&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">az_model</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_version&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">az_model</span> <span class="ow">in</span> <span class="n">AZ_MODEL_LIST</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Stability check flag</span>
    <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;stability_flag&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stability_flag</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stability_flag&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">stability_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing stability flag: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Hallucination check flag</span>
    <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;hallucination_check&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">hallucination_check</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hallucination_check&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">hallucination_check</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing hallucination check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Rerun retrosynthesis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span>
                      <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                      <span class="n">az_model</span><span class="o">=</span><span class="n">az_model</span><span class="p">,</span>
                      <span class="n">stability_flag</span><span class="o">=</span><span class="n">stability_flag</span><span class="p">,</span>
                      <span class="n">hallucination_check</span><span class="o">=</span><span class="n">hallucination_check</span><span class="p">)</span>

        <span class="c1"># Store the result in partial.json</span>
        <span class="n">save_result</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
             <span class="sa">f</span><span class="s2">&quot;Error in retrosynthesis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please rerun.&quot;</span><span class="p">}),</span> <span class="mi">500</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span></div>



<div class="viewcode-block" id="partial_rerun">
<a class="viewcode-back" href="../../api_module.html#src.api.partial_rerun">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/partial_rerun&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@require_api_key</span>
<span class="k">def</span><span class="w"> </span><span class="nf">partial_rerun</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint to perform a partial rerun of a retrosynthesis pathway.</span>

<span class="sd">    This complex endpoint allows modifying a previously computed retrosynthetic</span>
<span class="sd">    route by rerunning the synthesis from a specific intermediate step.</span>
<span class="sd">    It loads the last full retrosynthesis result (for the given `smiles`)</span>
<span class="sd">    from `partial.json`, identifies a target `step` in that pathway, and then</span>
<span class="sd">    initiates a new retrosynthesis (`src.main.main()`) starting from the product</span>
<span class="sd">    of that target step. The newly generated sub-pathway then replaces the</span>
<span class="sd">    original sub-pathway downstream of the target step.</span>

<span class="sd">    The logic involves:</span>

<span class="sd">    1.  Loading the previous result for `smiles` from `partial.json`.</span>
<span class="sd">    2.  Identifying the molecule (`start_molecule`) to resynthesize based on the</span>
<span class="sd">        product of the specified `steps` number in the loaded pathway.</span>
<span class="sd">    3.  Running a new retrosynthesis on `start_molecule` using provided or default</span>
<span class="sd">        LLM/AZ models and flags.</span>
<span class="sd">    4.  Identifying all original steps and dependencies that are downstream of (depend on)</span>
<span class="sd">        the `steps` chosen for rerun.</span>
<span class="sd">    5.  Removing these downstream steps and their dependencies.</span>
<span class="sd">    6.  Renumbering the steps from the new sub-pathway to follow existing steps.</span>
<span class="sd">    7.  Merging the kept original steps with the new renumbered sub-pathway steps</span>
<span class="sd">        and their dependencies.</span>
<span class="sd">    8.  Connecting the new sub-pathway to the original pathway at the point where</span>
<span class="sd">        the `steps` was branched from.</span>
<span class="sd">    9.  Saving the final merged result back to `partial.json`.</span>

<span class="sd">    **Request JSON Body:**</span>

<span class="sd">    -   `smiles` (str, required): The SMILES string of the original target molecule</span>
<span class="sd">        for which a result exists in `partial.json`.</span>
<span class="sd">    -   `steps` (int, required): The step number in the previously stored pathway</span>
<span class="sd">        from which the rerun should originate. The product of this step will be</span>
<span class="sd">        the starting molecule for the new synthesis.</span>
<span class="sd">    -   `model_type` (str, optional): LLM for the new sub-pathway. See `/api/retrosynthesis`.</span>
<span class="sd">    -   `advanced_prompt` (str or bool, optional): See `/api/retrosynthesis`.</span>
<span class="sd">    -   `model_version` (str, optional): AiZynthFinder model. See `/api/retrosynthesis`.</span>
<span class="sd">    -   `stability_flag` (str, optional): See `/api/retrosynthesis`.</span>
<span class="sd">    -   `hallucination_check` (str, optional): See `/api/retrosynthesis`.</span>

<span class="sd">    **Responses:**</span>

<span class="sd">    -   **200 OK:** Partial rerun successful. Body contains the merged JSON result.</span>
<span class="sd">    -   **400 Bad Request:** Invalid input (e.g., missing fields, `smiles` not found</span>
<span class="sd">        in `partial.json`, `steps` not found in pathway).</span>
<span class="sd">    -   **401 Unauthorized:** Missing or invalid API key.</span>
<span class="sd">    -   **404 Not Found:** If the specified `steps` number is not found in the</span>
<span class="sd">        loaded pathway for the given `smiles`.</span>
<span class="sd">    -   **500 Internal Server Error:** Unexpected error during processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===================== STARTING PARTIAL RERUN PROCESS =====================&quot;</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RECEIVED REQUEST DATA: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TARGET MOLECULE: </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">from_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TARGET STEP FOR RERUN: </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load previous results from partial.json</span>
        <span class="n">stored_smiles</span><span class="p">,</span> <span class="n">original_result</span> <span class="o">=</span> <span class="n">load_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOADED FROM STORAGE - SMILES: </span><span class="si">{</span><span class="n">stored_smiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">original_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: No results found in storage&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="s2">&quot;No previous results found. Run retrosynthesis first.&quot;</span>
            <span class="p">}),</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="n">stored_smiles</span> <span class="o">!=</span> <span class="n">smiles</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR: Stored SMILES (</span><span class="si">{</span><span class="n">stored_smiles</span><span class="si">}</span><span class="s2">) doesn&#39;t match requested SMILES (</span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="s2">&quot;No results found for this molecule. Run retrosynthesis first.&quot;</span>
            <span class="p">}),</span> <span class="mi">400</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FOUND STORED RESULT FOR SMILES: </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print the original steps for debugging</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ORIGINAL STEPS:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">original_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Step </span><span class="si">{</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print the original dependency structure for debugging</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ORIGINAL DEPENDENCIES: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">original_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Get the step we&#39;re rerunning from the original result</span>
        <span class="n">target_step</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">original_result</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">from_step</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_step</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Step </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2"> not found in synthesis pathway&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2"> not found in the synthesis pathway&quot;</span>
            <span class="p">}),</span> <span class="mi">404</span>

        <span class="c1"># Print the target step for debugging</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TARGET STEP DETAILS: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">target_step</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get the target molecule from the step&#39;s product</span>
        <span class="c1"># This is what we want to resynthesize with a new approach</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;products&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">target_step</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">target_step</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Step </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2"> doesn&#39;t have valid products&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
                 <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2"> doesn&#39;t have valid products&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="c1"># Log all products in the target step</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRODUCTS IN TARGET STEP:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_step</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Product </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">product</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get the first product&#39;s SMILES (this is what we&#39;ll resynthesize)</span>
        <span class="n">start_molecule</span> <span class="o">=</span> <span class="n">target_step</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STARTING NEW SYNTHESIS FROM MOLECULE: </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------</span>
        <span class="c1"># Advanced model - DeepSeek-R1</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>  <span class="c1"># Default is Claude 3 Opus</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;model_type&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;claude3&quot;</span><span class="p">,</span> <span class="s2">&quot;claude37&quot;</span><span class="p">,</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model type: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;claude3&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT MODEL TYPE: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Select the appropriate LLM based on model_type</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;deepseek&quot;</span><span class="p">:</span>
            <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;fireworks_ai/accounts/fireworks/models/deepseek-r1&quot;</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;claude37&quot;</span><span class="p">:</span>
            <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;anthropic/claude-3-7-sonnet-20250219&quot;</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default to Claude 3 Opus</span>
            <span class="n">llm</span> <span class="o">=</span> <span class="s2">&quot;claude-3-opus-20240229&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECTED LLM: </span><span class="si">{</span><span class="n">llm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------</span>
        <span class="c1"># Advanced prompt handling</span>
        <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;advanced_prompt&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;advanced_prompt&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">advanced_prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                    <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING ADVANCED PROMPT: </span><span class="si">{</span><span class="n">advanced_prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR PROCESSING ADVANCED PROMPT: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">advanced_prompt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">advanced_prompt</span><span class="p">:</span>
            <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="o">+</span> <span class="s2">&quot;:adv&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATED LLM WITH ADVANCED PROMPT: </span><span class="si">{</span><span class="n">llm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------</span>
        <span class="c1"># Choose AiZynthFinder model</span>
        <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;model_version&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">az_model</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_version&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">az_model</span> <span class="ow">in</span> <span class="n">AZ_MODEL_LIST</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING MODEL VERSION: </span><span class="si">{</span><span class="n">az_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR PROCESSING MODEL VERSION: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">az_model</span> <span class="o">=</span> <span class="s2">&quot;USPTO&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT MODEL: </span><span class="si">{</span><span class="n">az_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------</span>
        <span class="c1"># Stability check flag</span>
        <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;stability_flag&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">stability_flag</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stability_flag&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">stability_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING STABILITY FLAG: </span><span class="si">{</span><span class="n">stability_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR PROCESSING STABILITY FLAG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stability_flag</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT STABILITY FLAG: </span><span class="si">{</span><span class="n">stability_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------</span>
        <span class="c1"># Hallucination check flag</span>
        <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;hallucination_check&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">hallucination_check</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hallucination_check&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">hallucination_check</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USING HALLUCINATION CHECK: </span><span class="si">{</span><span class="n">hallucination_check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR PROCESSING HALLUCINATION CHECK: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">hallucination_check</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FALLING BACK TO DEFAULT HALLUCINATION CHECK: </span><span class="si">{</span><span class="n">hallucination_check</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Run new synthesis on the starting molecule</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CALLING MAIN FUNCTION WITH PARAMETERS:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SMILES: </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  LLM: </span><span class="si">{</span><span class="n">llm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  AZ MODEL: </span><span class="si">{</span><span class="n">az_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  STABILITY FLAG: </span><span class="si">{</span><span class="n">stability_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  HALLUCINATION CHECK: </span><span class="si">{</span><span class="n">hallucination_check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_result</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="n">start_molecule</span><span class="p">,</span>
                              <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                              <span class="n">az_model</span><span class="o">=</span><span class="n">az_model</span><span class="p">,</span>
                              <span class="n">stability_flag</span><span class="o">=</span><span class="n">stability_flag</span><span class="p">,</span>
                              <span class="n">hallucination_check</span><span class="o">=</span><span class="n">hallucination_check</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NEW RETROSYNTHESIS RESULT: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_result</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Note if the retrosynthesis result is empty, but treat it as a valid result</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NOTE: Empty synthesis result for </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2">. This molecule doesn&#39;t require further decomposition or is a building block.&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Initialize with empty steps and dependencies if not present</span>
                <span class="k">if</span> <span class="s1">&#39;steps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_result</span><span class="p">:</span>
                    <span class="n">new_result</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INITIALIZED empty steps list&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;dependencies&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_result</span><span class="p">:</span>
                    <span class="n">new_result</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INITIALIZED empty dependencies dict&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR RUNNING RETROSYNTHESIS ON MOLECULE </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  EXCEPTION: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TRACEBACK: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="sa">f</span><span class="s2">&quot;Error running retrosynthesis on </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}),</span> <span class="mi">500</span>

        <span class="c1"># The steps to remove are the target step and everything it depends on</span>
        <span class="c1"># In other words, the target step and everything to its right in the synthesis pathway</span>
        <span class="n">steps_to_remove</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">from_step</span><span class="p">)}</span>
        <span class="n">steps_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">from_step</span><span class="p">)]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IDENTIFYING STEPS TO REMOVE:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  STARTING WITH STEP: </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Identify all steps that the target step depends on (to the right in the pathway)</span>
        <span class="c1"># This is the set of steps that will be replaced by the new synthesis</span>
        <span class="k">while</span> <span class="n">steps_to_check</span><span class="p">:</span>
            <span class="n">current_step</span> <span class="o">=</span> <span class="n">steps_to_check</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CHECKING DEPENDENCIES FOR STEP: </span><span class="si">{</span><span class="n">current_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_step</span> <span class="ow">in</span> <span class="n">original_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">{}):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    FOUND DEPENDENCIES: </span><span class="si">{</span><span class="n">original_result</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">][</span><span class="n">current_step</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">dep_step</span> <span class="ow">in</span> <span class="n">original_result</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">][</span><span class="n">current_step</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">dep_step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span><span class="p">:</span>
                        <span class="n">steps_to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_step</span><span class="p">)</span>
                        <span class="n">steps_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_step</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ADDED STEP </span><span class="si">{</span><span class="n">dep_step</span><span class="si">}</span><span class="s2"> TO REMOVAL LIST&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;STEPS TO REMOVE (TARGET AND EVERYTHING TO ITS RIGHT): </span><span class="si">{</span><span class="n">steps_to_remove</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># We need to identify what step the target step is connected to on its left</span>
        <span class="c1"># This is where we&#39;ll connect the new synthesis</span>
        <span class="n">left_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="n">original_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_step</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deps</span> <span class="ow">and</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span><span class="p">:</span>
                <span class="n">left_connection</span> <span class="o">=</span> <span class="n">step</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;FOUND LEFT CONNECTION: STEP </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> DEPENDS ON STEP </span><span class="si">{</span><span class="n">from_step</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;LEFT CONNECTION (STEP THAT THE TARGET CONNECTS TO ON THE LEFT): </span><span class="si">{</span><span class="n">left_connection</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Keep steps that are not in the steps_to_remove set</span>
        <span class="n">kept_steps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">step</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">original_result</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span>
        <span class="p">]</span>

        <span class="c1"># Keep dependencies for steps we&#39;re keeping, removing any references to removed steps</span>
        <span class="n">kept_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">step_num</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="n">original_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span><span class="p">:</span>
                <span class="c1"># Filter out dependencies that are in steps_to_remove</span>
                <span class="n">kept_deps</span><span class="p">[</span><span class="n">step_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span>
                <span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KEPT STEPS: </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kept_steps</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KEPT DEPENDENCIES: </span><span class="si">{</span><span class="n">kept_deps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Find max step number from kept steps</span>
        <span class="n">max_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">kept_steps</span><span class="p">:</span>
            <span class="n">max_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">kept_steps</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAX STEP NUMBER FROM KEPT STEPS: </span><span class="si">{</span><span class="n">max_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no steps were kept, there might be a problem</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: No steps from original pathway were kept!&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust new steps (renumber them starting from max_step + 1)</span>
        <span class="n">new_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RENUMBERING NEW STEPS STARTING FROM </span><span class="si">{</span><span class="n">max_step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">new_step_num</span> <span class="o">=</span> <span class="n">max_step</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">idx</span>
            <span class="n">old_step_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>  <span class="c1"># Convert to string for consistency</span>
            <span class="n">step_mapping</span><span class="p">[</span><span class="n">old_step_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_step_num</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAPPING STEP </span><span class="si">{</span><span class="n">old_step_num</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_step_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">adjusted_step</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">adjusted_step</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_step_num</span><span class="p">)</span>
            <span class="n">new_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adjusted_step</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEW STEPS AFTER RENUMBERING: </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">new_steps</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust dependencies for new steps</span>
        <span class="n">new_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ADJUSTING DEPENDENCIES FOR NEW STEPS:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="n">new_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">old_num</span><span class="p">)</span>  <span class="c1"># Convert to string for consistency</span>
            <span class="n">new_num</span> <span class="o">=</span> <span class="n">step_mapping</span><span class="p">[</span><span class="n">old_num</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  STEP </span><span class="si">{</span><span class="n">old_num</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2"> DEPENDS ON:&quot;</span><span class="p">)</span>

            <span class="c1"># Map old step numbers to new step numbers in dependencies</span>
            <span class="n">mapped_deps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># Convert to string for consistency</span>
                <span class="n">mapped_d</span> <span class="o">=</span> <span class="n">step_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="n">mapped_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_d</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    OLD DEP </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2"> -&gt; NEW DEP </span><span class="si">{</span><span class="n">mapped_d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">new_deps</span><span class="p">[</span><span class="n">new_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_deps</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEW DEPENDENCIES AFTER RENUMBERING: </span><span class="si">{</span><span class="n">new_deps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Connect the new branch to the left connection if it exists</span>
        <span class="k">if</span> <span class="n">left_connection</span> <span class="ow">and</span> <span class="n">new_steps</span><span class="p">:</span>
            <span class="n">first_new_step</span> <span class="o">=</span> <span class="n">new_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CONNECTING LEFT STEP </span><span class="si">{</span><span class="n">left_connection</span><span class="si">}</span><span class="s2"> TO NEW STEP </span><span class="si">{</span><span class="n">first_new_step</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">left_connection</span> <span class="ow">in</span> <span class="n">kept_deps</span><span class="p">:</span>
                <span class="n">kept_deps</span><span class="p">[</span><span class="n">left_connection</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_new_step</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  ADDED </span><span class="si">{</span><span class="n">first_new_step</span><span class="si">}</span><span class="s2"> TO EXISTING DEPENDENCIES OF </span><span class="si">{</span><span class="n">left_connection</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">kept_deps</span><span class="p">[</span><span class="n">left_connection</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kept_deps</span><span class="p">[</span><span class="n">left_connection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_new_step</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  CREATED NEW DEPENDENCIES FOR </span><span class="si">{</span><span class="n">left_connection</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">kept_deps</span><span class="p">[</span><span class="n">left_connection</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Merge results - this should include ALL kept steps AND new steps</span>
        <span class="n">merged_steps</span> <span class="o">=</span> <span class="n">kept_steps</span> <span class="o">+</span> <span class="n">new_steps</span>
        <span class="n">merged_deps</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kept_deps</span><span class="p">,</span> <span class="o">**</span><span class="n">new_deps</span><span class="p">}</span>

        <span class="c1"># Verify the merging was successful</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FINAL MERGED STEPS: </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">merged_steps</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FINAL MERGED DEPENDENCIES: </span><span class="si">{</span><span class="n">merged_deps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Final debug check - NOTE: Empty results are now considered valid when a molecule</span>
        <span class="c1"># is identified as a building block or starting material</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_steps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;NOTE: Final result has no steps. The molecule was identified as a building block or starting material and doesn&#39;t require further synthesis.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Create a minimal result that acknowledges this molecule as a building block</span>
            <span class="n">merged_result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>  <span class="c1"># Add the original SMILES</span>
                <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span>
                <span class="sa">f</span><span class="s2">&quot;The molecule </span><span class="si">{</span><span class="n">start_molecule</span><span class="si">}</span><span class="s2"> was identified as a building block or starting material and doesn&#39;t require further synthesis.&quot;</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">merged_steps</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: NO STEPS IN FINAL MERGED RESULT!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No steps in final merged result&quot;</span><span class="p">}),</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create the normal merged result</span>
            <span class="n">merged_result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>  <span class="c1"># Add the original SMILES to the result</span>
                <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="n">merged_steps</span><span class="p">,</span>
                <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="n">merged_deps</span>
            <span class="p">}</span>

        <span class="c1"># Store the merged result in partial.json</span>
        <span class="n">save_result</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">merged_result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SAVED MERGED RESULT TO </span><span class="si">{</span><span class="n">PARTIAL_JSON_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===================== PARTIAL RERUN COMPLETE =====================&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">merged_result</span><span class="p">),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FATAL ERROR IN PARTIAL RERUN:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  EXCEPTION: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TRACEBACK: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span>
                        <span class="sa">f</span><span class="s2">&quot;Error in partial retrosynthesis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">500</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Project Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>